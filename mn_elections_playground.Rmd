---
title: "mn_elections_playground"
author: "Luke Kolar"
date: "10/3/2020"
output: html_document
---

```{r, message = F}

## Loading necessary packages...

library(geojsonio)
library(rgdal)
library(raster)
library(rgeos)
library(cowplot)
library(rcartocolor)
library(zipcodeR)
library(broom)
library(sf)
library(janitor)

# `tidyverse` last...
library(tidyverse)

```

```{r}

## Important recycled objects:

elec.col.names <- c("state", "county_id", "precinct_name",
                    "office_id", "office_name", "district", 
                    "candidate_order_code", "candidate_name",
                    "suffix", "incumbent_code", "party_affiliation",
                    "num_precincts_reporting", "total_num_precincts_voting",
                    "candidate_votes", "candidate_percent_vote", "total_race_votes")

county_ids <- read.delim("relevant_county_data/county_ids.txt", 
  sep = ";", header = FALSE, col.names = c("county_id", "county_name", 
                                           "county_num_precincts")) %>% 
  mutate(county_name = str_to_title(county_name)) %>% 
  mutate(county_name = str_replace(county_name, " Of The ", " of the ")) %>% 
  mutate(county_name = str_replace(county_name, " Qui ", " qui "))

county_positions <- tibble(title = c("Commissioner", "Auditor", "Treasurer", 
                                     "Auditor/Treasurer", "Recorder", "Sheriff", "Attorney", 
                                     "Soil and Water Supervisor", "Surveyor", 
                                     "Park Commissioner", "Coroner"),
                           code = c("COM", "AUD", "TRS", "A&T", "REC", "SHF", "ATR",
                                    "S&W", "SRV", "PCM", "COR"))

```

```{r, eval = F}

# all precincts reporting?
sb_2018 %>% 
  mutate(test = num_precincts_reporting - total_num_precincts_voting) %>% 
  group_by(test) %>% 
  summarize(n = n())

# all non-partisan?
sb_2018 %>% 
  group_by(party_affiliation) %>% 
  summarize(n = n())

# no suffixes?
sb_2018 %>% 
  group_by(suffix) %>% 
  summarize(n = n())

# incumbent codes?
sb_2018 %>% 
  group_by(incumbent_code) %>% 
  summarize(n = n())

```


```{r}

## Practicing with the 2018 dataset

sb_2018 <- read.delim("relevant_schooldist_data/schooldist_races_datasets/2018_schoolboard.txt", 
  sep = ";", header = FALSE, col.names = elec.col.names) %>% 
  select(office_name, candidate_name, total_num_precincts_voting,
         candidate_votes, candidate_percent_vote, total_race_votes) %>% 
  mutate(special = ifelse(grepl("Special", office_name), TRUE, FALSE)) %>% 
  mutate(position = ifelse(grepl("Position", office_name), 
                           str_match(office_name, "(?<=Position )[:digit:]*"), 
                           "at-large")) %>% 
  mutate(district = ifelse(grepl("District [[:digit:]]", office_name), 
                           str_match(office_name, "(?<=District )[:digit:]*"), 
                           ifelse(grepl("District", office_name), 
                                  str_match(office_name, 
                                            "(?<=Member ).*(?= District)"), NA))) %>% 
  mutate(elect = ifelse(grepl("Elect [[:digit:]]", office_name), 
                        str_match(office_name, "(?<=Elect )[:digit:]*"),
                        1)) %>% 
  mutate(sd_type = ifelse(grepl("ISD", office_name), "ISD",
                          ifelse(grepl("SDD", office_name), "SSD", "CSD"))) %>% 
  mutate(sd_code = ifelse(sd_type == "ISD", 1,
                          ifelse(sd_type == "SSD", 3, 2))) %>% 
  mutate(sd_code = sprintf("%02d", sd_code)) %>% 
  mutate(sd_num = ifelse(grepl("ISD", office_name), 
                     str_extract(office_name, "(?<=ISD #)[:digit:]*"),
                     ifelse(grepl("SSD", office_name), 
                            str_extract(office_name, "(?<=SSD #)[:digit:]*"),
                            "none"))) %>% 
  mutate(sd_num = as.numeric(sd_num)) %>% 
  mutate(sd_num = sprintf("%04d", sd_num)) %>% 
  mutate(elect = as.numeric(elect)) %>% 
  select(candidate_name, sd_num, sd_code, sd_type, total_num_precincts_voting, elect, 
         position, district, special, office_name)
  
sb_2018_grouped <- sb_2018 %>% 
  group_by(sd_num, sd_code, total_num_precincts_voting) %>% 
  summarise(num_candidates = n()) %>% 
  ungroup()

```

```{r}

## Practice map with oversimplified variable

schooldist_map_18_19_raw <- readOGR( 
  dsn = paste0(getwd(),"/relevant_schooldist_data/shp_bdry_school_district_2010s/"), 
  layer = "school_district_boundaries_2018_19",
  verbose = FALSE) 

schooldist_map_18_19_messy <- spTransform(schooldist_map_18_19_raw, 
            CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))

schooldist_map_18_19 <- st_as_sf(schooldist_map_18_19_messy) %>% 
  rename(sd_code = UNI_TYP,
         sd_num = UNI_MAJ,
         dist_name = UNI_NAM) %>% clean_names() %>%
  mutate(sd_num = sprintf("%04d", sd_num),
         sd_code = sprintf("%02d", sd_code)) %>% 
  select(sd_code, sd_num, dist_name, sqmiles, acres, geometry) 
  
school_dist_elections_18 <- schooldist_map_18_19 %>% 
  full_join(sb_2018_grouped, by = c("sd_code", "sd_num"))

ggplot(school_dist_elections_18, aes(fill = num_candidates)) + 
  geom_sf(color = "grey30", lwd = 0.25) + 
  theme_void() + scale_fill_gradient(low = "white", high = "red")

```

```{r}
## Inspecting and cleaning county races

clean_county <- function(year = c(2000:2020), type = c("general", "primary")){
  
  election <- if(type == "general"){"gen"}else{if(type == "primary"){"primary"}else{
    stop("Variable \`type\` must be \"general\" or \"primary\" (note quotations)")}}
  
  read.delim(paste0("relevant_county_data/county_races_datasets/", 
                    year, "_county_", election, ".txt"), 
  sep = ";", header = FALSE, col.names = elec.col.names) %>% clean_names() %>% 
  select(county_id, office_id:candidate_name,
         total_num_precincts_voting:total_race_votes) %>% 
  mutate(office_name = str_to_title(office_name)) %>%
  filter(!grepl(c("Question"), office_name)) %>% 
  filter(grepl(c("Soil|County"), office_name)) %>% 
  mutate(special = ifelse(grepl("Special", office_name), TRUE, FALSE)) %>% 
  mutate(office_name = str_remove(office_name, "Special Election For ")) %>% 
  mutate(district = as.numeric(ifelse(grepl("District [[:digit:]]", office_name), 
                           str_match(office_name, "(?<=District )[:digit:]*"), 
                           ifelse(grepl("District", office_name), 
                                  str_match(office_name, 
                                            "(?<=Member ).*(?= District)"), NA)))) %>% 
  mutate(office_name = str_remove(office_name, "County ")) %>% 
  mutate(office_name = str_remove(office_name, " District.*$")) %>% 
  mutate(office_name = str_replace(office_name, " And ", " and ")) %>% 
  mutate(office_name = str_replace(office_name, "Auditor - Treasurer",
                                   "Auditor/Treasurer")) %>% 
  mutate(other_county_id = ifelse(grepl("Marshall-Beltrami", office_name),
                               ifelse(county_id == 4, 45, 4), NA)) %>% 
  mutate(office_name = str_remove(office_name, "Marshall-Beltrami ")) %>% 
  mutate(candidate_name = str_to_title(candidate_name))
  
}

clean_county(2014, "general") %>% filter(county_id == 18) %>% 
  select(office_name, district, candidate_name, candidate_votes, 
         candidate_percent_vote, special) %>% View

```


```{r}
counties_map_raw <- readOGR( 
  dsn = paste0(getwd(),"/relevant_county_data/shp_bdry_counties/"), 
  layer = "mn_county_boundaries",
  verbose = FALSE) 

counties_map_messy <- spTransform(counties_map_raw, 
            CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))

counties_map <- st_as_sf(counties_map_messy) %>% 
  rename(county_id = COUN,
         county_name = CTY_NAME) %>% clean_names() %>%
  select(county_id, county_name, cty_abbr, geometry) 

?readxl

county_pop_2019 <- readxl("relevant_county_data/county_pop_estimates_2019.xlsx", 
                          col.names = c("county_id", "county_name", "county_num_precincts"))

ggplot(counties_map, aes()) + 
  geom_sf(fill = "blue", color = "black", lwd = 0.25) + 
  theme_void()

```



